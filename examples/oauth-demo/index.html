<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentAPI Proxy - GitHub OAuth ãƒ‡ãƒ¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        button {
            background-color: #0366d6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0256c7;
        }
        button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }
        .error {
            color: #dc2626;
            background-color: #fee;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .success {
            color: #059669;
            background-color: #d1fae5;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .info {
            background-color: #e0e7ff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .code {
            font-family: 'Consolas', 'Monaco', monospace;
            background-color: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 14px;
        }
        .hidden {
            display: none;
        }
        .session-info {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 14px;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .flex {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .flex input {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” AgentAPI Proxy - GitHub OAuth ãƒ‡ãƒ¢</h1>
        
        <div class="info">
            <strong>ä½¿ã„æ–¹:</strong>
            <ol>
                <li>ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®URLã‚’è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: http://localhost:8080ï¼‰</li>
                <li>ã€ŒGitHubã§ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>GitHubã§èªè¨¼ã‚’æ‰¿èª</li>
                <li>èªè¨¼å¾Œã€AgentAPIã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã§ãã¾ã™</li>
            </ol>
            <p><strong>æ³¨æ„:</strong> ã“ã®ãƒ‡ãƒ¢ã¯OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã€GitHub OAuthã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£ã—ãæ§‹æˆã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
        </div>

        <!-- è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>âš™ï¸ è¨­å®š</h2>
            <label for="proxyUrl">ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼URL:</label>
            <input type="text" id="proxyUrl" value="http://localhost:8080" />
            <label for="redirectUri">ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIï¼ˆã“ã®ãƒšãƒ¼ã‚¸ã®URLï¼‰:</label>
            <input type="text" id="redirectUri" value="" />
        </div>

        <!-- èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ”‘ èªè¨¼çŠ¶æ…‹</h2>
            <div id="authStatus">
                <p>æœªèªè¨¼</p>
                <button onclick="startOAuth()">GitHubã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
            <div id="userInfo" class="session-info hidden"></div>
        </div>

        <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="sessionSection" class="section hidden">
            <h2>ğŸš€ AgentAPIã‚»ãƒƒã‚·ãƒ§ãƒ³</h2>
            <div class="flex">
                <input type="text" id="sessionTag" placeholder="ã‚¿ã‚°ï¼ˆä¾‹: project-nameï¼‰" />
                <button onclick="createSession()">æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ</button>
            </div>
            <button onclick="listSessions()">ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§</button>
            <div id="sessionList" class="session-info hidden"></div>
        </div>

        <!-- ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ“ ãƒ­ã‚°</h2>
            <pre id="logs">ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</pre>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let sessionId = null;
        let userContext = null;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.onload = function() {
            // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã‚’è‡ªå‹•è¨­å®š
            const redirectUri = window.location.origin + window.location.pathname;
            document.getElementById('redirectUri').value = redirectUri;

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆOAuthã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            const params = new URLSearchParams(window.location.search);
            if (params.has('code') && params.has('state')) {
                handleOAuthCallback(params.get('code'), params.get('state'));
            } else {
                // ä¿å­˜ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
                checkExistingSession();
            }
        };

        // ãƒ­ã‚°å‡ºåŠ›
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#6b7280';
            logs.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        // OAuthèªè¨¼é–‹å§‹
        async function startOAuth() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const redirectUri = document.getElementById('redirectUri').value;

            log('OAuthèªè¨¼ã‚’é–‹å§‹ã—ã¾ã™...');

            try {
                const response = await fetch(`${proxyUrl}/oauth/authorize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ redirect_uri: redirectUri })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                log('èªè¨¼URLã‚’å–å¾—ã—ã¾ã—ãŸ', 'success');
                log(`State: ${data.state}`);

                // stateã‚’ä¿å­˜
                sessionStorage.setItem('oauth_state', data.state);

                // GitHubã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                log('GitHubã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™...');
                window.location.href = data.auth_url;

            } catch (error) {
                log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // OAuthã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
        async function handleOAuthCallback(code, state) {
            log('OAuthã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‡¦ç†ä¸­...');

            // stateæ¤œè¨¼
            const savedState = sessionStorage.getItem('oauth_state');
            if (state !== savedState) {
                log('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼: stateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;

            try {
                const response = await fetch(`${proxyUrl}/oauth/callback?code=${code}&state=${state}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                log('èªè¨¼æˆåŠŸï¼', 'success');
                log(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${data.session_id}`);
                log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${data.user.user_id} (${data.user.role})`);

                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜
                sessionId = data.session_id;
                userContext = data.user;
                localStorage.setItem('agentapi_session_id', sessionId);
                localStorage.setItem('agentapi_user', JSON.stringify(userContext));

                // UIã‚’æ›´æ–°
                updateAuthUI(true);

                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                window.history.replaceState({}, document.title, window.location.pathname);
                sessionStorage.removeItem('oauth_state');

            } catch (error) {
                log(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
        async function checkExistingSession() {
            const savedSessionId = localStorage.getItem('agentapi_session_id');
            const savedUser = localStorage.getItem('agentapi_user');

            if (savedSessionId && savedUser) {
                sessionId = savedSessionId;
                userContext = JSON.parse(savedUser);

                log('ä¿å­˜ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºèªä¸­...');

                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ç¢ºèª
                const proxyUrl = document.getElementById('proxyUrl').value;
                try {
                    const response = await fetch(`${proxyUrl}/search`, {
                        headers: { 'X-Session-ID': sessionId }
                    });

                    if (response.ok) {
                        log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯æœ‰åŠ¹ã§ã™', 'success');
                        updateAuthUI(true);
                    } else {
                        log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã§ã™', 'error');
                        clearSession();
                    }
                } catch (error) {
                    log(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    clearSession();
                }
            }
        }

        // UIæ›´æ–°
        function updateAuthUI(authenticated) {
            const authStatus = document.getElementById('authStatus');
            const userInfo = document.getElementById('userInfo');
            const sessionSection = document.getElementById('sessionSection');

            if (authenticated && userContext) {
                authStatus.innerHTML = `
                    <p>âœ… èªè¨¼æ¸ˆã¿</p>
                    <button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    <button onclick="refreshSession()">ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°</button>
                `;

                userInfo.innerHTML = `
                    <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h3>
                    <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</strong> ${userContext.user_id}</p>
                    <p><strong>ãƒ­ãƒ¼ãƒ«:</strong> ${userContext.role}</p>
                    <p><strong>æ¨©é™:</strong> ${userContext.permissions.join(', ')}</p>
                    <p><strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³ID:</strong> <span class="code">${sessionId}</span></p>
                `;
                userInfo.classList.remove('hidden');
                sessionSection.classList.remove('hidden');
            } else {
                authStatus.innerHTML = `
                    <p>æœªèªè¨¼</p>
                    <button onclick="startOAuth()">GitHubã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                `;
                userInfo.classList.add('hidden');
                sessionSection.classList.add('hidden');
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function logout() {
            const proxyUrl = document.getElementById('proxyUrl').value;

            log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­...');

            try {
                await fetch(`${proxyUrl}/oauth/logout`, {
                    method: 'POST',
                    headers: { 'X-Session-ID': sessionId }
                });
                log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                log(`ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }

            clearSession();
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°
        async function refreshSession() {
            const proxyUrl = document.getElementById('proxyUrl').value;

            log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ä¸­...');

            try {
                const response = await fetch(`${proxyUrl}/oauth/refresh`, {
                    method: 'POST',
                    headers: { 'X-Session-ID': sessionId }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                log(`æœ‰åŠ¹æœŸé™: ${new Date(data.expires_at).toLocaleString()}`);

            } catch (error) {
                log(`ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢
        function clearSession() {
            sessionId = null;
            userContext = null;
            localStorage.removeItem('agentapi_session_id');
            localStorage.removeItem('agentapi_user');
            updateAuthUI(false);
        }

        // AgentAPIã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
        async function createSession() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const tag = document.getElementById('sessionTag').value;

            log('AgentAPIã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆä¸­...');

            try {
                const response = await fetch(`${proxyUrl}/start`, {
                    method: 'POST',
                    headers: {
                        'X-Session-ID': sessionId,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tags: tag ? { name: tag } : {},
                        environment: { DEBUG: 'true' }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                log('AgentAPIã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
                log(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${data.session_id}`);

                // ã‚¿ã‚°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('sessionTag').value = '';

                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’æ›´æ–°
                await listSessions();

            } catch (error) {
                log(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§å–å¾—
        async function listSessions() {
            const proxyUrl = document.getElementById('proxyUrl').value;

            log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’å–å¾—ä¸­...');

            try {
                const response = await fetch(`${proxyUrl}/search`, {
                    headers: { 'X-Session-ID': sessionId }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                log(`${data.sessions.length}å€‹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`, 'success');

                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º
                const sessionList = document.getElementById('sessionList');
                if (data.sessions.length > 0) {
                    sessionList.innerHTML = '<h3>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³</h3>';
                    data.sessions.forEach(session => {
                        const startTime = new Date(session.started_at).toLocaleString();
                        const tags = session.tags ? Object.entries(session.tags).map(([k, v]) => `${k}=${v}`).join(', ') : '';
                        sessionList.innerHTML += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #f9fafb; border-radius: 4px;">
                                <p><strong>ID:</strong> <span class="code">${session.session_id}</span></p>
                                <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ${session.status}</p>
                                <p><strong>é–‹å§‹æ™‚åˆ»:</strong> ${startTime}</p>
                                <p><strong>ãƒãƒ¼ãƒˆ:</strong> ${session.port}</p>
                                ${tags ? `<p><strong>ã‚¿ã‚°:</strong> ${tags}</p>` : ''}
                            </div>
                        `;
                    });
                    sessionList.classList.remove('hidden');
                } else {
                    sessionList.innerHTML = '<p>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                    sessionList.classList.remove('hidden');
                }

            } catch (error) {
                log(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>