name: Build Development Helm Chart

on:
  workflow_dispatch:
    inputs:
      git_ref:
        description: 'Git reference (branch, tag, or commit hash) to build from'
        required: false
        default: ''
        type: string
      chart_version_suffix:
        description: 'Chart version suffix (e.g., "-dev", "-alpha.1")'
        required: false
        default: '-dev'
        type: string
      dry_run:
        description: 'Dry run (validate only, do not push)'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  CHART_NAME: agentapi-proxy

permissions:
  contents: read
  packages: write

jobs:
  trigger-docker-build:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    outputs:
      image_tag: ${{ steps.trigger.outputs.image_tag }}
    steps:
      - name: Determine Git reference
        id: git_ref
        run: |
          if [ -n "${{ github.event.inputs.git_ref }}" ]; then
            echo "ref=${{ github.event.inputs.git_ref }}" >> $GITHUB_OUTPUT
            echo "Using specified git reference: ${{ github.event.inputs.git_ref }}"
          else
            echo "ref=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "Using current branch: ${{ github.ref_name }}"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.git_ref.outputs.ref }}

      - name: Get commit hash
        id: commit
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "Commit hash: $COMMIT_HASH"
          echo "image_tag=dev-$COMMIT_HASH" >> $GITHUB_OUTPUT

      - name: Trigger Docker image build
        if: ${{ github.event.inputs.dry_run != 'true' }}
        id: trigger
        run: |
          echo "Triggering Docker image build for commit ${{ steps.commit.outputs.hash }}..."
          
          # Trigger the dev image build workflow
          gh workflow run "Build Development Image" \
            --repo ${{ github.repository }} \
            --ref ${{ steps.git_ref.outputs.ref }} \
            -f git_ref=${{ steps.git_ref.outputs.ref }} \
            -f platforms="linux/amd64" \
            -f tag_suffix=""
          
          echo "Docker build triggered. Waiting for it to start..."
          sleep 10
          
          # Get the run ID of the triggered workflow
          RUN_ID=$(gh run list \
            --workflow="Build Development Image" \
            --repo ${{ github.repository }} \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')
          
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "image_tag=dev-${{ steps.commit.outputs.hash }}" >> $GITHUB_OUTPUT
          echo "Docker build workflow run ID: $RUN_ID"
          echo "Expected image tag: dev-${{ steps.commit.outputs.hash }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for Docker image build
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "Waiting for Docker image build to complete (run ID: ${{ steps.trigger.outputs.run_id }})..."
          
          # Wait for the workflow to complete (max 20 minutes)
          gh run watch ${{ steps.trigger.outputs.run_id }} \
            --repo ${{ github.repository }} \
            --interval 30 \
            --exit-status || {
              echo "Warning: Docker build may have failed or is taking longer than expected"
              echo "Continuing with Helm chart build anyway..."
            }
          
          echo "Docker image build completed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-dev-helm-chart:
    runs-on: ubuntu-latest
    needs: trigger-docker-build
    if: always()
    steps:
      - name: Determine Git reference
        id: git_ref
        run: |
          if [ -n "${{ github.event.inputs.git_ref }}" ]; then
            echo "ref=${{ github.event.inputs.git_ref }}" >> $GITHUB_OUTPUT
            echo "Using specified git reference: ${{ github.event.inputs.git_ref }}"
          else
            echo "ref=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "Using current branch: ${{ github.ref_name }}"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.git_ref.outputs.ref }}

      - name: Get commit information
        id: commit
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "full_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "date=$(date -u +"%Y%m%d%H%M%S")" >> $GITHUB_OUTPUT
          echo "Commit hash: $COMMIT_HASH"
          
          # Use the image tag from Docker build if available
          if [ -n "${{ needs.trigger-docker-build.outputs.image_tag }}" ]; then
            echo "Using Docker build image tag: ${{ needs.trigger-docker-build.outputs.image_tag }}"
          else
            echo "Docker build was skipped (dry run mode)"
          fi

      - name: Generate chart version
        id: version
        run: |
          # Get base version from Chart.yaml
          BASE_VERSION=$(grep '^version:' helm/${{ env.CHART_NAME }}/Chart.yaml | awk '{print $2}')
          
          # Generate development version
          # Format: <base-version>-dev.<date>.<commit-hash>
          DEV_VERSION="${BASE_VERSION}${{ github.event.inputs.chart_version_suffix }}.${{ steps.commit.outputs.date }}.${{ steps.commit.outputs.hash }}"
          
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "dev_version=$DEV_VERSION" >> $GITHUB_OUTPUT
          echo "Generated chart version: $DEV_VERSION"

      - name: Update Chart.yaml with dev version
        run: |
          # Backup original Chart.yaml
          cp helm/${{ env.CHART_NAME }}/Chart.yaml helm/${{ env.CHART_NAME }}/Chart.yaml.bak
          
          # Update version
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.dev_version }}/" helm/${{ env.CHART_NAME }}/Chart.yaml
          
          # Update appVersion to use the dev image tag
          sed -i "s/^appVersion:.*/appVersion: \"dev-${{ steps.commit.outputs.hash }}\"/" helm/${{ env.CHART_NAME }}/Chart.yaml
          
          echo "Updated Chart.yaml:"
          grep -E "^(version|appVersion):" helm/${{ env.CHART_NAME }}/Chart.yaml

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.18.3'

      - name: Install additional tools
        run: |
          # Install kubeval for manifest validation
          curl -L https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz | tar xz
          sudo mv kubeval /usr/local/bin
          
          # Install yamllint
          pip install yamllint

      - name: Lint YAML files
        run: |
          echo "Running yamllint on Helm chart files..."
          # Create yamllint config that excludes templates directory and relaxes some rules
          cat > /tmp/yamllint-config.yaml << 'EOF'
          extends: default
          rules:
            line-length:
              max: 200
            comments-indentation: disable
            braces: disable
            trailing-spaces: disable
            empty-lines:
              max-end: 1
          ignore: |
            helm/**/templates/
          EOF
          
          yamllint -c /tmp/yamllint-config.yaml helm/${{ env.CHART_NAME }}/

      - name: Lint Helm chart
        run: |
          echo "Running Helm lint..."
          helm lint helm/${{ env.CHART_NAME }}/ --strict

      - name: Package Helm chart
        run: |
          helm package helm/${{ env.CHART_NAME }}/ --destination /tmp/
          
          CHART_FILE=$(ls /tmp/${{ env.CHART_NAME }}-*.tgz)
          echo "chart_file=$CHART_FILE" >> $GITHUB_ENV
          echo "Packaged chart: $CHART_FILE"
          
          # Display package contents
          echo "Chart package contents:"
          tar -tzf "$CHART_FILE" | head -20

      - name: Login to GitHub Container Registry
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} --username ${{ github.actor }} --password-stdin

      - name: Push chart to OCI registry
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "Pushing chart to OCI registry..."
          helm push "${{ env.chart_file }}" oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts
          
          echo "âœ… Chart pushed successfully!"
          echo "Pull with: helm pull oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }} --version ${{ steps.version.outputs.dev_version }}"

      - name: Generate installation instructions
        id: install_instructions
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "instructions=Dry run completed. Chart was not pushed to registry." >> $GITHUB_OUTPUT
          else
            cat >> install_instructions.txt << 'EOF'
          # Development Helm Chart Installation

          ## Add Helm repository (if using Helm < 3.8)
          ```bash
          helm registry login ${{ env.REGISTRY }} --username <github-username> --password <github-token>
          ```

          ## Install the development chart
          ```bash
          helm install agentapi-proxy-dev \
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }} \
            --version ${{ steps.version.outputs.dev_version }}
          ```

          ## Install with custom values
          ```bash
          helm install agentapi-proxy-dev \
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }} \
            --version ${{ steps.version.outputs.dev_version }} \
            --set config.enableMultipleUsers=true
          ```

          ## Upgrade existing installation
          ```bash
          helm upgrade agentapi-proxy-dev \
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }} \
            --version ${{ steps.version.outputs.dev_version }}
          ```

          ## Uninstall
          ```bash
          helm uninstall agentapi-proxy-dev
          ```
          EOF
            echo "instructions_file=install_instructions.txt" >> $GITHUB_OUTPUT
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: helm-dev-${{ steps.version.outputs.dev_version }}
          path: |
            /tmp/${{ env.CHART_NAME }}-*.tgz
            install_instructions.txt
            helm/${{ env.CHART_NAME }}/Chart.yaml
          retention-days: 7

      - name: Create GitHub summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŽ¯ Development Helm Chart Build
          
          ## ðŸ“Š Build Information
          
          | Property | Value |
          |----------|-------|
          | Chart Name | `${{ env.CHART_NAME }}` |
          | Base Version | `${{ steps.version.outputs.base_version }}` |
          | Dev Version | `${{ steps.version.outputs.dev_version }}` |
          | Git Reference | `${{ steps.git_ref.outputs.ref }}` |
          | Commit | `${{ steps.commit.outputs.hash }}` |
          | App Version | `dev-${{ steps.commit.outputs.hash }}` |
          | Docker Image | `${{ env.REGISTRY }}/${{ github.repository }}:dev-${{ steps.commit.outputs.hash }}` |
          | Dry Run | `${{ github.event.inputs.dry_run }}` |
          
          ## ðŸ³ Docker Image Build
          
          EOF
          
          if [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          - âœ… Docker image build triggered and completed
          - Image: `${{ env.REGISTRY }}/${{ github.repository }}:dev-${{ steps.commit.outputs.hash }}`
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          - â­ï¸ Docker image build skipped (dry run mode)
          EOF
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ## ðŸ§ª Validation Results

          - âœ… YAML lint passed
          - âœ… Helm lint passed (strict mode)
          
          ## ðŸ“¦ Package Information
          
          - Package: `${{ env.chart_file }}`
          - Registry: `${{ env.REGISTRY }}/${{ github.repository_owner }}/charts`
          
          EOF
          
          if [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ## ðŸš€ Installation
          
          ### Quick Install
          ```bash
          helm install agentapi-proxy-dev \
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }} \
            --version ${{ steps.version.outputs.dev_version }}
          ```
          
          ### With Custom Values
          ```bash
          helm install agentapi-proxy-dev \
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }} \
            --version ${{ steps.version.outputs.dev_version }} \
            --values custom-values.yaml
          ```
          
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ## âš ï¸ Dry Run Mode
          
          This was a dry run. The chart was validated but not pushed to the registry.
          
          EOF
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ## ðŸ”— Links
          
          - [Source Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.commit.outputs.full_hash }})
          - [Chart Registry](https://github.com/${{ github.repository }}/pkgs/container/charts%2F${{ env.CHART_NAME }})
          - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

      - name: Display summary
        if: always()
        run: |
          echo "=========================================="
          echo "  Development Helm Chart Build Complete"
          echo "=========================================="
          echo ""
          echo "ðŸ“‹ Chart Version: ${{ steps.version.outputs.dev_version }}"
          echo "ðŸ·ï¸ App Version: dev-${{ steps.commit.outputs.hash }}"
          echo "ðŸ“¦ Package: ${{ env.chart_file }}"
          echo ""
          if [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            echo "ðŸš€ Install with:"
            echo "  helm install agentapi-proxy-dev \\"
            echo "    oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts/${{ env.CHART_NAME }} \\"
            echo "    --version ${{ steps.version.outputs.dev_version }}"
          else
            echo "âš ï¸ Dry run completed - chart was not pushed to registry"
          fi
          echo ""
          echo "=========================================="