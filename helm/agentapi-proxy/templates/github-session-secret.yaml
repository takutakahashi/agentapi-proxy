{{- if and .Values.kubernetesSession.enabled .Values.kubernetesSession.github.enabled }}
{{- /*
  GitHub Session Secret
  This Secret contains GitHub authentication credentials for the clone-repo init container
  in session pods. It supports two authentication methods:

  1. Personal Access Token (GITHUB_TOKEN)
  2. GitHub App (GITHUB_APP_ID, GITHUB_INSTALLATION_ID, GITHUB_APP_PEM)

  Values are inherited from top-level github.app settings if not explicitly set
  in kubernetesSession.github.
*/}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.kubernetesSession.github.secretName | default (printf "%s-github-session" (include "agentapi-proxy.fullname" .)) }}
  labels:
    {{- include "agentapi-proxy.labels" . | nindent 4 }}
    app.kubernetes.io/component: github-session-credentials
type: Opaque
stringData:
  {{- /* Option 1: Personal Access Token */}}
  {{- if .Values.kubernetesSession.github.token }}
  GITHUB_TOKEN: {{ .Values.kubernetesSession.github.token | quote }}
  {{- end }}
  {{- /* Option 2: GitHub App credentials */}}
  {{- /* Use kubernetesSession.github values if set, otherwise inherit from github.app */}}
  {{- $appId := .Values.kubernetesSession.github.appId | default .Values.github.app.id }}
  {{- $installationId := .Values.kubernetesSession.github.installationId | default .Values.github.app.installationId }}
  {{- if $appId }}
  GITHUB_APP_ID: {{ $appId | quote }}
  {{- end }}
  {{- if $installationId }}
  GITHUB_INSTALLATION_ID: {{ $installationId | quote }}
  {{- end }}
  {{- /* GitHub App PEM - use kubernetesSession.github.pem if set */}}
  {{- if .Values.kubernetesSession.github.pem }}
  GITHUB_APP_PEM: |
{{ .Values.kubernetesSession.github.pem | indent 4 }}
  {{- end }}
  {{- /* GitHub Enterprise API URL */}}
  {{- $apiUrl := .Values.kubernetesSession.github.apiUrl | default .Values.github.enterprise.apiUrl }}
  {{- if $apiUrl }}
  GITHUB_API: {{ $apiUrl | quote }}
  {{- end }}
{{- end }}
