{{- if and .Values.kubernetesSession.enabled .Values.github.app.id .Values.github.app.privateKey.secretName }}
{{- /*
  GitHub Session Secret
  This Secret contains GitHub authentication credentials for the clone-repo init container
  in session pods. Uses existing github.app and github.enterprise settings from values.yaml.

  The PEM content is read from the existing Secret specified in github.app.privateKey.secretName
  using Helm's lookup function. This requires the PEM Secret to exist before running helm install/upgrade.
*/}}
{{- $pemSecret := "" }}
{{- $pemKey := .Values.github.app.privateKey.key | default "private-key" }}
{{- if .Values.github.app.privateKey.secretName }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace .Values.github.app.privateKey.secretName }}
{{- if $existingSecret }}
{{- $pemSecret = index $existingSecret.data $pemKey | default "" }}
{{- end }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "agentapi-proxy.fullname" . }}-github-session
  labels:
    {{- include "agentapi-proxy.labels" . | nindent 4 }}
    app.kubernetes.io/component: github-session-credentials
type: Opaque
data:
  {{- /* PEM from existing Secret (base64 encoded) */}}
  {{- if $pemSecret }}
  GITHUB_APP_PEM: {{ $pemSecret }}
  {{- end }}
stringData:
  {{- /* GitHub App credentials from github.app settings */}}
  {{- if .Values.github.app.id }}
  GITHUB_APP_ID: {{ .Values.github.app.id | quote }}
  {{- end }}
  {{- if .Values.github.app.installationId }}
  GITHUB_INSTALLATION_ID: {{ .Values.github.app.installationId | quote }}
  {{- end }}
  {{- /* GitHub Enterprise API URL from github.enterprise settings */}}
  {{- if .Values.github.enterprise.apiUrl }}
  GITHUB_API: {{ .Values.github.enterprise.apiUrl | quote }}
  {{- end }}
{{- end }}
