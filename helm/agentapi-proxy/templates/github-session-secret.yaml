{{- $hasToken := .Values.github.token }}
{{- $hasApp := and .Values.github.app.id .Values.github.app.privateKey.secretName }}
{{- if or $hasToken $hasApp }}
{{- /*
  GitHub Session Secret (Authentication)
  This Secret contains GitHub authentication credentials for the clone-repo init container
  in session pods. Uses existing github settings from values.yaml.

  Supports two authentication methods:
  1. Personal Access Token (github.token)
  2. GitHub App (github.app.id, github.app.privateKey.secretName)

  The PEM content is read from the existing Secret specified in github.app.privateKey.secretName
  using Helm's lookup function. This requires the PEM Secret to exist before running helm install/upgrade.

  Note: GITHUB_API and GITHUB_URL are in a separate Secret (github-config) so that
  params.github_token can override authentication without losing Enterprise Server settings.
*/}}
{{- $pemSecret := "" }}
{{- $pemKey := .Values.github.app.privateKey.key | default "private-key" }}
{{- if .Values.github.app.privateKey.secretName }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace .Values.github.app.privateKey.secretName }}
{{- if $existingSecret }}
{{- $pemSecret = index $existingSecret.data $pemKey | default "" }}
{{- end }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "agentapi-proxy.fullname" . }}-github-session
  labels:
    {{- include "agentapi-proxy.labels" . | nindent 4 }}
    app.kubernetes.io/component: github-session-credentials
type: Opaque
data:
  {{- /* PEM from existing Secret (base64 encoded) */}}
  {{- if $pemSecret }}
  GITHUB_APP_PEM: {{ $pemSecret }}
  {{- end }}
stringData:
  {{- /* Personal Access Token */}}
  {{- if .Values.github.token }}
  GITHUB_TOKEN: {{ .Values.github.token | quote }}
  {{- end }}
  {{- /* GitHub App credentials from github.app settings */}}
  {{- if .Values.github.app.id }}
  GITHUB_APP_ID: {{ .Values.github.app.id | quote }}
  {{- end }}
  {{- if .Values.github.app.installationId }}
  GITHUB_INSTALLATION_ID: {{ .Values.github.app.installationId | quote }}
  {{- end }}
{{- end }}
---
{{- /*
  GitHub Config Secret (Enterprise Server Settings)
  This Secret contains GitHub Enterprise Server URL settings.
  Kept separate from authentication credentials so that params.github_token
  can override GITHUB_TOKEN without losing GITHUB_API and GITHUB_URL settings.
*/}}
{{- if or .Values.github.enterprise.apiUrl .Values.github.enterprise.baseUrl }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "agentapi-proxy.fullname" . }}-github-config
  labels:
    {{- include "agentapi-proxy.labels" . | nindent 4 }}
    app.kubernetes.io/component: github-config
type: Opaque
stringData:
  {{- if .Values.github.enterprise.apiUrl }}
  GITHUB_API: {{ .Values.github.enterprise.apiUrl | quote }}
  {{- end }}
  {{- if .Values.github.enterprise.baseUrl }}
  GITHUB_URL: {{ .Values.github.enterprise.baseUrl | quote }}
  {{- end }}
{{- end }}
