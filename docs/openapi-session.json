{
  "openapi": "3.0.3",
  "info": {
    "title": "AgentAPI Proxy - Session API",
    "description": "API for managing agent sessions. Each session runs an independent agentapi server instance.",
    "version": "1.0.0"
  },
  "servers": [
    {
      "url": "/",
      "description": "Current server"
    }
  ],
  "paths": {
    "/start": {
      "post": {
        "summary": "Create a new session",
        "description": "Creates a new session and starts an agentapi server instance. Returns the session ID for subsequent requests.",
        "operationId": "createSession",
        "tags": ["Sessions"],
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/StartRequest"
              },
              "examples": {
                "basic": {
                  "summary": "Basic session",
                  "value": {
                    "tags": {
                      "repository": "org/repo",
                      "branch": "main"
                    }
                  }
                },
                "with-environment": {
                  "summary": "Session with environment variables",
                  "value": {
                    "environment": {
                      "CUSTOM_VAR": "value"
                    },
                    "tags": {
                      "repository": "org/repo"
                    }
                  }
                },
                "with-params": {
                  "summary": "Session with initial message",
                  "value": {
                    "tags": {
                      "repository": "org/repo"
                    },
                    "params": {
                      "message": "Review the latest PRs"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Session created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "session_id": {
                      "type": "string",
                      "description": "Unique session identifier (UUID)"
                    }
                  },
                  "required": ["session_id"]
                },
                "example": {
                  "session_id": "abc123-def456-ghi789"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized"
          },
          "500": {
            "description": "Failed to create session",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/search": {
      "get": {
        "summary": "Search sessions",
        "description": "Returns a list of sessions. Non-admin users can only see their own sessions. Supports filtering by status and tags.",
        "operationId": "searchSessions",
        "tags": ["Sessions"],
        "parameters": [
          {
            "name": "status",
            "in": "query",
            "description": "Filter by session status",
            "schema": {
              "$ref": "#/components/schemas/SessionStatus"
            }
          },
          {
            "name": "tag.{key}",
            "in": "query",
            "description": "Filter by tag value (e.g., tag.repository=org/repo)",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "List of sessions",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "sessions": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/SessionResponse"
                      }
                    }
                  }
                },
                "example": {
                  "sessions": [
                    {
                      "session_id": "abc123-def456-ghi789",
                      "user_id": "user123",
                      "status": "active",
                      "started_at": "2025-01-15T14:00:00Z",
                      "addr": "localhost:9000",
                      "tags": {
                        "repository": "org/repo",
                        "branch": "main"
                      },
                      "description": "Review the latest PRs"
                    }
                  ]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized"
          }
        }
      }
    },
    "/sessions/{sessionId}": {
      "delete": {
        "summary": "Delete a session",
        "description": "Terminates and deletes a session. Users can only delete their own sessions.",
        "operationId": "deleteSession",
        "tags": ["Sessions"],
        "parameters": [
          {
            "name": "sessionId",
            "in": "path",
            "required": true,
            "description": "Session ID",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Session deleted successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string",
                      "example": "Session terminated successfully"
                    },
                    "session_id": {
                      "type": "string"
                    },
                    "status": {
                      "type": "string",
                      "example": "terminated"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Session ID is required"
          },
          "403": {
            "description": "Forbidden - can only delete own sessions"
          },
          "404": {
            "description": "Session not found"
          },
          "500": {
            "description": "Failed to delete session"
          }
        }
      }
    },
    "/{sessionId}/{path}": {
      "summary": "Proxy to session",
      "description": "All requests to /{sessionId}/* are proxied to the corresponding agentapi server instance.",
      "get": {
        "summary": "Proxy GET request to session",
        "operationId": "proxyGetToSession",
        "tags": ["Session Proxy"],
        "parameters": [
          {
            "name": "sessionId",
            "in": "path",
            "required": true,
            "description": "Session ID",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "path",
            "in": "path",
            "required": true,
            "description": "Path to forward to agentapi",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Response from agentapi server"
          },
          "403": {
            "description": "Forbidden - can only access own sessions"
          },
          "404": {
            "description": "Session not found"
          },
          "502": {
            "description": "Bad Gateway - agentapi server unavailable"
          }
        }
      },
      "post": {
        "summary": "Proxy POST request to session",
        "operationId": "proxyPostToSession",
        "tags": ["Session Proxy"],
        "parameters": [
          {
            "name": "sessionId",
            "in": "path",
            "required": true,
            "description": "Session ID",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "path",
            "in": "path",
            "required": true,
            "description": "Path to forward to agentapi",
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "description": "Request body to forward to agentapi",
          "content": {
            "application/json": {
              "schema": {
                "type": "object"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Response from agentapi server"
          },
          "403": {
            "description": "Forbidden - can only access own sessions"
          },
          "404": {
            "description": "Session not found"
          },
          "502": {
            "description": "Bad Gateway - agentapi server unavailable"
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "StartRequest": {
        "type": "object",
        "properties": {
          "environment": {
            "type": "object",
            "additionalProperties": {
              "type": "string"
            },
            "description": "Environment variables for the session"
          },
          "tags": {
            "type": "object",
            "additionalProperties": {
              "type": "string"
            },
            "description": "Tags for the session (e.g., repository, branch)"
          },
          "params": {
            "$ref": "#/components/schemas/SessionParams"
          }
        }
      },
      "SessionParams": {
        "type": "object",
        "properties": {
          "message": {
            "type": "string",
            "description": "Initial message to send to the agent after session starts"
          },
          "github_token": {
            "type": "string",
            "description": "GitHub token to use for authentication instead of GitHub App"
          }
        }
      },
      "SessionResponse": {
        "type": "object",
        "properties": {
          "session_id": {
            "type": "string",
            "description": "Unique session identifier"
          },
          "user_id": {
            "type": "string",
            "description": "Owner user ID"
          },
          "status": {
            "$ref": "#/components/schemas/SessionStatus"
          },
          "started_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the session was started"
          },
          "addr": {
            "type": "string",
            "description": "Address of the agentapi server (host:port)"
          },
          "tags": {
            "type": "object",
            "additionalProperties": {
              "type": "string"
            },
            "description": "Session tags"
          },
          "description": {
            "type": "string",
            "description": "Session description (initial message or tags.description)"
          }
        }
      },
      "SessionStatus": {
        "type": "string",
        "enum": ["creating", "starting", "active", "unhealthy", "stopped", "unknown"],
        "description": "Session status. 'creating' = session just created, 'starting' = pod is starting, 'active' = pod is running, 'unhealthy' = pod is in error state, 'stopped' = deployment deleted, 'unknown' = error getting status"
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "message": {
            "type": "string"
          }
        }
      }
    },
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "description": "GitHub OAuth token or API key"
      },
      "apiKey": {
        "type": "apiKey",
        "in": "header",
        "name": "X-API-Key",
        "description": "Static API key"
      }
    }
  },
  "security": [
    {
      "bearerAuth": []
    },
    {
      "apiKey": []
    }
  ],
  "tags": [
    {
      "name": "Sessions",
      "description": "Session lifecycle management"
    },
    {
      "name": "Session Proxy",
      "description": "Proxy requests to agentapi server instances"
    }
  ]
}
